<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®Œæ•´ EPUB é˜…è¯»å™¨</title>
  <!-- ä½¿ç”¨å¯ç”¨çš„ CDN é“¾æ¥ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
  <style>
    :root {
      --primary-color: #4a6fa5;
      --bg-color: #f8f9fa;
      --text-color: #333;
      --card-bg: #ffffff;
      --border-color: #e1e5e9;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --primary-color: #6d9ed3;
      --bg-color: #1a1d24;
      --text-color: #e6eef8;
      --card-bg: #2d333c;
      --border-color: #3a4250;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background-color: var(--card-bg);
      padding: 1.5rem 0;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 1.8rem;
      color: var(--primary-color);
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .btn-icon {
      font-size: 1.2rem;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    main {
      display: flex;
      min-height: calc(100vh - 120px);
    }

    .sidebar {
      width: 280px;
      background-color: var(--card-bg);
      padding: 20px;
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      transition: transform 0.3s;
    }

    .book-info {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .book-cover {
      width: 150px;
      height: 200px;
      background-color: var(--border-color);
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      overflow: hidden;
    }

    .book-cover img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }

    .book-cover-placeholder {
      font-size: 3rem;
      color: var(--primary-color);
    }

    .book-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .book-author {
      color: #888;
      font-size: 0.9rem;
    }

    .sidebar-section {
      margin-bottom: 25px;
    }

    .sidebar-section h3 {
      font-size: 1rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toc-list {
      list-style: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .toc-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: color 0.2s;
    }

    .toc-item:hover {
      color: var(--primary-color);
    }

    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .settings-option label {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      width: 100%;
    }

    select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
    }

    .viewer-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .viewer-controls {
      display: flex;
      justify-content: space-between;
      padding: 15px 20px;
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
    }

    .viewer-nav {
      display: flex;
      gap: 10px;
    }

    .progress-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .progress-bar {
      width: 200px;
      height: 6px;
      background-color: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s;
    }

    #viewer {
      flex: 1;
      overflow: hidden;
      position: relative;
      background-color: var(--card-bg);
    }

    #viewer .epub-container {
      width: 100%;
      height: 100%;
      background: white;
    }

    [data-theme="dark"] #viewer .epub-container {
      background: #2d333c;
    }

    .viewer-content {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--card-bg);
      box-shadow: var(--shadow);
      border-radius: 8px;
      padding: 40px;
      min-height: 100%;
    }

    .welcome-screen {
      text-align: center;
      padding: 60px 20px;
    }

    .welcome-icon {
      font-size: 4rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .welcome-screen h2 {
      margin-bottom: 15px;
    }

    .welcome-screen p {
      margin-bottom: 30px;
      color: #888;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .hidden {
      display: none !important;
    }

    .mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 101;
      background-color: var(--primary-color);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: var(--shadow);
    }

    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      flex-direction: column;
      gap: 20px;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      z-index: 1001;
      max-width: 400px;
      width: 90%;
    }

    .error-message.active {
      display: block;
    }

    .error-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #e74c3c;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        position: fixed;
        height: 100%;
        z-index: 99;
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .mobile-toggle {
        display: flex;
      }
      
      .viewer-controls {
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .progress-info {
        order: 3;
        width: 100%;
        justify-content: center;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>æ­£åœ¨åŠ è½½ EPUB æ–‡ä»¶...</div>
  </div>
  
  <div class="error-message" id="error-message">
    <div class="error-icon">âš ï¸</div>
    <h3>åŠ è½½å¤±è´¥</h3>
    <p id="error-text">æ— æ³•åŠ è½½ EPUB æ–‡ä»¶</p>
    <button class="btn" style="margin-top: 15px;" onclick="hideError()">
      ç¡®å®š
    </button>
  </div>
  
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">ğŸ“–</div>
          <h1>EPUB é˜…è¯»å™¨</h1>
        </div>
        <div class="controls">
          <div class="file-input-wrapper">
            <button class="btn" id="file-btn">
              <span class="btn-icon">ğŸ“‚</span>
              æ‰“å¼€ EPUB
            </button>
            <input type="file" id="file-input" accept=".epub" />
          </div>
          <button id="theme-toggle" class="btn btn-outline">
            <span class="btn-icon">ğŸŒ™</span>
            ä¸»é¢˜
          </button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="sidebar">
      <div class="book-info">
        <div class="book-cover">
          <div class="book-cover-placeholder">ğŸ“š</div>
        </div>
        <div class="book-title">è¯·é€‰æ‹© EPUB æ–‡ä»¶</div>
        <div class="book-author">ä½œè€…ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
      </div>
      
      <div class="sidebar-section">
        <h3><span class="btn-icon">ğŸ“‘</span> ç›®å½•</h3>
        <ul class="toc-list" id="toc">
          <li class="toc-item">è¯·å…ˆé€‰æ‹© EPUB æ–‡ä»¶</li>
        </ul>
      </div>
      
      <div class="sidebar-section">
        <h3><span class="btn-icon">âš™ï¸</span> é˜…è¯»è®¾ç½®</h3>
        <div class="settings-option">
          <label for="fontsize">
            <span class="btn-icon">ğŸ”¤</span>
            å­—ä½“å¤§å°
          </label>
          <span id="fontsize-value">16px</span>
        </div>
        <input type="range" id="fontsize" min="12" max="28" value="16">
        
        <div class="settings-option">
          <label for="lineheight">
            <span class="btn-icon">â†•ï¸</span>
            è¡Œé«˜
          </label>
          <span id="lineheight-value">1.5</span>
        </div>
        <input type="range" id="lineheight" min="1" max="2" step="0.1" value="1.5">
        
        <div class="settings-option">
          <label for="fontfamily">
            <span class="btn-icon">ğŸ–‹ï¸</span>
            å­—ä½“
          </label>
        </div>
        <select id="fontfamily">
          <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">é»˜è®¤å­—ä½“</option>
          <option value="'Times New Roman', Times, serif">Times New Roman</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="'Courier New', Courier, monospace">Courier New</option>
        </select>
      </div>
    </div>
    
    <div class="viewer-container">
      <div class="viewer-controls">
        <div class="viewer-nav">
          <button id="prev" class="btn btn-outline" disabled>
            <span class="btn-icon">â—€</span>
            ä¸Šä¸€é¡µ
          </button>
          <button id="next" class="btn btn-outline" disabled>
            ä¸‹ä¸€é¡µ
            <span class="btn-icon">â–¶</span>
          </button>
        </div>
        
        <div class="progress-info">
          <span id="page-info">0 / 0</span>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <span id="progress-percent">0%</span>
        </div>
      </div>
      
      <div id="viewer">
        <div class="viewer-content" id="welcome-content">
          <div class="welcome-screen">
            <div class="welcome-icon">ğŸ“š</div>
            <h2>æ¬¢è¿ä½¿ç”¨ EPUB é˜…è¯»å™¨</h2>
            <p>è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ EPUB ç”µå­ä¹¦é˜…è¯»å™¨ï¼Œæ”¯æŒè‡ªå®šä¹‰å­—ä½“ã€å­—å·ã€è¡Œé«˜å’Œä¸»é¢˜åˆ‡æ¢ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹© EPUB æ–‡ä»¶å¼€å§‹é˜…è¯»ã€‚</p>
            <div class="file-input-wrapper">
              <button class="btn" style="padding: 12px 24px;">
                <span class="btn-icon">ğŸ“‚</span>
                é€‰æ‹© EPUB æ–‡ä»¶
              </button>
              <input type="file" id="file-input-welcome" accept=".epub" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mobile-toggle" id="sidebar-toggle">
      <span>â˜°</span>
    </div>
  </main>

  <script>
    // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦åŠ è½½æˆåŠŸ
    function checkLibrariesLoaded() {
      const errors = [];
      
      if (typeof JSZip === 'undefined') {
        errors.push('JSZip åº“æœªæ­£ç¡®åŠ è½½');
      }
      
      if (typeof ePub === 'undefined') {
        errors.push('EPUB åº“æœªæ­£ç¡®åŠ è½½');
      }
      
      if (errors.length > 0) {
        showError('å¿…è¦çš„åº“åŠ è½½å¤±è´¥ï¼š' + errors.join('ï¼Œ') + 'ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
        return false;
      }
      
      return true;
    }

    let book, rendition;
    let currentLocation = null;
    let isBookLoaded = false;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
      if (!checkLibrariesLoaded()) {
        return;
      }

      console.log('æ‰€æœ‰å¿…è¦çš„åº“å·²åŠ è½½æˆåŠŸ');
      
      // æ–‡ä»¶è¾“å…¥äº‹ä»¶
      document.getElementById('file-input').addEventListener('change', handleFileSelect);
      document.getElementById('file-input-welcome').addEventListener('change', handleFileSelect);
      
      // æ§åˆ¶æŒ‰é’®äº‹ä»¶
      document.getElementById('prev').addEventListener('click', () => {
        if (rendition && isBookLoaded) {
          rendition.prev().catch(handleNavigationError);
        }
      });
      
      document.getElementById('next').addEventListener('click', () => {
        if (rendition && isBookLoaded) {
          rendition.next().catch(handleNavigationError);
        }
      });
      
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
      
      // è®¾ç½®å˜åŒ–äº‹ä»¶
      document.getElementById('fontsize').addEventListener('input', updateFontSize);
      document.getElementById('lineheight').addEventListener('input', updateLineHeight);
      document.getElementById('fontfamily').addEventListener('change', updateFontFamily);
      
      // æ¢å¤è®¾ç½®
      restoreSettings();
    });

    // å¤„ç†å¯¼èˆªé”™è¯¯
    function handleNavigationError(error) {
      console.log('å¯¼èˆªé”™è¯¯:', error);
      // å¿½ç•¥ç« èŠ‚æŸ¥æ‰¾é”™è¯¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„è¾¹ç•Œæƒ…å†µ
      if (error.message && error.message.includes('No Section Found')) {
        return;
      }
      showError('ç¿»é¡µå¤±è´¥: ' + error.message);
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const errorText = document.getElementById('error-text');
      const errorMessage = document.getElementById('error-message');
      
      if (errorText && errorMessage) {
        errorText.textContent = message;
        errorMessage.classList.add('active');
      } else {
        alert(message);
      }
    }

    // éšè—é”™è¯¯ä¿¡æ¯
    function hideError() {
      const errorMessage = document.getElementById('error-message');
      if (errorMessage) {
        errorMessage.classList.remove('active');
      }
    }

    // å®‰å…¨åœ°éšè—å…ƒç´ 
    function safeHideElement(selector) {
      try {
        const element = document.querySelector(selector);
        if (element) {
          element.classList.add('hidden');
        }
      } catch (error) {
        console.log('éšè—å…ƒç´ æ—¶å‡ºé”™:', error);
      }
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    async function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      if (!file.name.toLowerCase().endsWith('.epub')) {
        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„ EPUB æ–‡ä»¶');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const loading = document.getElementById('loading');
      if (loading) loading.classList.add('active');
      
      try {
        // é‡ç½®çŠ¶æ€
        isBookLoaded = false;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const bookTitle = document.querySelector('.book-title');
        const bookAuthor = document.querySelector('.book-author');
        if (bookTitle) bookTitle.textContent = 'åŠ è½½ä¸­...';
        if (bookAuthor) bookAuthor.textContent = '';
        
        const arrayBuffer = await file.arrayBuffer();
        
        // åˆ›å»ºæ–°çš„ EPUB å®ä¾‹
        book = ePub(arrayBuffer);
        
        // ç­‰å¾…ä¹¦ç±åŠ è½½å®Œæˆ
        await book.ready;
        
        // è·å–ä¹¦ç±å…ƒæ•°æ®
        const metadata = book.packaging.metadata;
        
        // æ›´æ–°ä¹¦ç±ä¿¡æ¯
        if (bookTitle) bookTitle.textContent = metadata.title || 'æœªçŸ¥æ ‡é¢˜';
        if (bookAuthor) bookAuthor.textContent = metadata.creator || 'æœªçŸ¥ä½œè€…';
        
        // å°è¯•è·å–å°é¢
        try {
          const coverUrl = await book.coverUrl();
          const bookCover = document.querySelector('.book-cover');
          if (coverUrl && bookCover) {
            bookCover.innerHTML = `<img src="${coverUrl}" alt="å°é¢">`;
          }
        } catch (err) {
          console.log('æ— æ³•åŠ è½½å°é¢ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡');
        }
        
        // åˆå§‹åŒ–é˜…è¯»å™¨
        await initReader();
        
        // ç”Ÿæˆç›®å½•
        await generateTOC();
        
        // å®‰å…¨åœ°éšè—æ¬¢è¿ç•Œé¢
        safeHideElement('#welcome-content');
        
        isBookLoaded = true;
        
      } catch (error) {
        console.error('åŠ è½½ EPUB æ–‡ä»¶æ—¶å‡ºé”™:', error);
        showError('æ— æ³•åŠ è½½è¯¥ EPUB æ–‡ä»¶ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      } finally {
        // éšè—åŠ è½½çŠ¶æ€
        if (loading) loading.classList.remove('active');
      }
    }

    // åˆå§‹åŒ–é˜…è¯»å™¨
    async function initReader() {
      // å¦‚æœå·²æœ‰é˜…è¯»å™¨å®ä¾‹ï¼Œå…ˆé”€æ¯
      if (rendition) {
        try {
          rendition.destroy();
        } catch (e) {
          console.log('é”€æ¯æ—§é˜…è¯»å™¨æ—¶å‡ºé”™:', e);
        }
      }
      
      // æ¸…é™¤ä¹‹å‰çš„é˜…è¯»å™¨å†…å®¹
      const viewer = document.getElementById('viewer');
      if (viewer) {
        viewer.innerHTML = '';
      }
      
      try {
        // åˆ›å»ºæ–°çš„é˜…è¯»å™¨å®ä¾‹ - ä½¿ç”¨æ»šåŠ¨æ¨¡å¼é¿å…ç« èŠ‚é—®é¢˜
        rendition = book.renderTo(viewer, {
          width: "100%",
          height: "100%",
          manager: "default",
          flow: "scrolled", // ä½¿ç”¨æ»šåŠ¨æ¨¡å¼è€Œä¸æ˜¯åˆ†é¡µ
          spread: "none" // ç¦ç”¨åŒé¡µå±•å¼€
        });
        
        // åº”ç”¨å½“å‰è®¾ç½®
        applySettings();
        
        // ç­‰å¾…ä¹¦ç±ä½ç½®åŠ è½½
        await book.locations.generate(1024); // ç”Ÿæˆä½ç½®ä¿¡æ¯
        
        // æ¢å¤é˜…è¯»ä½ç½®
        const lastPos = localStorage.getItem('epub_pos');
        if (lastPos) {
          try {
            await rendition.display(lastPos);
          } catch (e) {
            console.log('æ¢å¤ä½ç½®å¤±è´¥ï¼Œä»å¼€å§‹é˜…è¯»');
            await rendition.display();
          }
        } else {
          await rendition.display();
        }
        
        // ç›‘å¬ä½ç½®å˜åŒ–
        rendition.on('relocated', function(location) {
          currentLocation = location;
          savePosition();
          updateProgress();
          updateNavigationButtons();
        });
        
        rendition.on('rendered', function(section) {
          currentLocation = section;
          savePosition();
          updateProgress();
          updateNavigationButtons();
        });
        
        // ç›‘å¬æ˜¾ç¤ºé”™è¯¯
        rendition.on('displayError', function(error) {
          console.log('æ˜¾ç¤ºé”™è¯¯:', error);
          // å¿½ç•¥ç« èŠ‚æœªæ‰¾åˆ°çš„é”™è¯¯
          if (error.message && error.message.includes('No Section Found')) {
            return;
          }
          showError('æ˜¾ç¤ºå†…å®¹æ—¶å‡ºé”™: ' + error.message);
        });
        
        // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        updateNavigationButtons();
        
      } catch (error) {
        console.error('åˆå§‹åŒ–é˜…è¯»å™¨æ—¶å‡ºé”™:', error);
        showError('åˆå§‹åŒ–é˜…è¯»å™¨å¤±è´¥ï¼š' + error.message);
      }
    }

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      
      if (rendition && isBookLoaded) {
        if (prevBtn) prevBtn.disabled = false;
        if (nextBtn) nextBtn.disabled = false;
      }
    }

    // åº”ç”¨è®¾ç½®
    function applySettings() {
      if (!rendition) return;
      
      const fontSize = document.getElementById('fontsize').value + 'px';
      const lineHeight = document.getElementById('lineheight').value;
      const fontFamily = document.getElementById('fontfamily').value;
      
      try {
        rendition.themes.default({
          'body': {
            'font-size': fontSize,
            'line-height': lineHeight,
            'font-family': fontFamily,
            'color': 'var(--text-color)',
            'background-color': 'var(--card-bg)',
            'margin': '0',
            'padding': '20px'
          },
          'p': {
            'margin-bottom': '1em',
            'text-align': 'justify'
          },
          'h1, h2, h3, h4, h5, h6': {
            'margin-top': '1.5em',
            'margin-bottom': '0.5em'
          },
          'a': {
            'color': 'var(--primary-color)'
          }
        });
        
        // æ›´æ–°æ˜¾ç¤ºå€¼
        const fontSizeValue = document.getElementById('fontsize-value');
        const lineHeightValue = document.getElementById('lineheight-value');
        if (fontSizeValue) fontSizeValue.textContent = fontSize;
        if (lineHeightValue) lineHeightValue.textContent = lineHeight;
      } catch (error) {
        console.log('åº”ç”¨è®¾ç½®æ—¶å‡ºé”™:', error);
      }
    }

    // ç”Ÿæˆç›®å½•
    async function generateTOC() {
      try {
        const toc = book.navigation.toc;
        const tocList = document.getElementById('toc');
        
        if (!tocList) return;
        
        tocList.innerHTML = '';
        
        if (toc && toc.length > 0) {
          toc.forEach(item => {
            const li = document.createElement('li');
            li.className = 'toc-item';
            li.textContent = item.label;
            li.addEventListener('click', async () => {
              if (rendition) {
                try {
                  await rendition.display(item.href);
                  // åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»ç›®å½•åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
                  if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) sidebar.classList.remove('active');
                  }
                } catch (error) {
                  console.log('è·³è½¬ç« èŠ‚å¤±è´¥:', error);
                  // å¿½ç•¥ç« èŠ‚æœªæ‰¾åˆ°çš„é”™è¯¯
                  if (!error.message.includes('No Section Found')) {
                    showError('è·³è½¬ç« èŠ‚å¤±è´¥: ' + error.message);
                  }
                }
              }
            });
            tocList.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.className = 'toc-item';
          li.textContent = 'æœ¬ä¹¦æ²¡æœ‰ç›®å½•';
          tocList.appendChild(li);
        }
      } catch (error) {
        console.log('ç”Ÿæˆç›®å½•æ—¶å‡ºé”™:', error);
        const tocList = document.getElementById('toc');
        if (tocList) {
          tocList.innerHTML = '<li class="toc-item">ç›®å½•åŠ è½½å¤±è´¥</li>';
        }
      }
    }

    // ä¿å­˜é˜…è¯»ä½ç½®
    function savePosition() {
      if (!book || !rendition) return;
      
      try {
        if (currentLocation && currentLocation.start) {
          const cfi = currentLocation.start.cfi;
          localStorage.setItem('epub_pos', cfi);
        }
      } catch (error) {
        console.log('ä¿å­˜ä½ç½®å¤±è´¥:', error);
      }
    }

    // æ›´æ–°é˜…è¯»è¿›åº¦
    function updateProgress() {
      if (!book || !rendition) return;
      
      try {
        if (book.locations && currentLocation && currentLocation.start) {
          const percentage = book.locations.percentageFromCfi(currentLocation.start.cfi);
          const progressPercent = Math.round(percentage * 100);
          
          const progressPercentEl = document.getElementById('progress-percent');
          const progressFill = document.getElementById('progress-fill');
          const pageInfo = document.getElementById('page-info');
          
          if (progressPercentEl) progressPercentEl.textContent = `${progressPercent}%`;
          if (progressFill) progressFill.style.width = `${progressPercent}%`;
          
          // æ›´æ–°é¡µé¢ä¿¡æ¯
          if (book.locations && book.locations.total && pageInfo) {
            const currentPage = Math.round(book.locations.total * percentage);
            pageInfo.textContent = `${currentPage} / ${book.locations.total}`;
          }
        }
      } catch (error) {
        console.log('è¿›åº¦è®¡ç®—é”™è¯¯:', error);
      }
    }

    // æ›´æ–°å­—ä½“å¤§å°
    function updateFontSize() {
      applySettings();
      saveSettings();
    }

    // æ›´æ–°è¡Œé«˜
    function updateLineHeight() {
      applySettings();
      saveSettings();
    }

    // æ›´æ–°å­—ä½“
    function updateFontFamily() {
      applySettings();
      saveSettings();
    }

    // åˆ‡æ¢ä¸»é¢˜
    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('epub_theme', newTheme);
      
      // æ›´æ–°ä¸»é¢˜å›¾æ ‡
      const themeIcon = document.querySelector('#theme-toggle .btn-icon');
      if (themeIcon) {
        themeIcon.textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
      }
      
      // é‡æ–°åº”ç”¨è®¾ç½®ä»¥æ›´æ–°é˜…è¯»å™¨é¢œè‰²
      applySettings();
    }

    // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.classList.toggle('active');
      }
    }

    // ä¿å­˜è®¾ç½®
    function saveSettings() {
      const settings = {
        fontSize: document.getElementById('fontsize').value,
        lineHeight: document.getElementById('lineheight').value,
        fontFamily: document.getElementById('fontfamily').value
      };
      
      localStorage.setItem('epub_settings', JSON.stringify(settings));
    }

    // æ¢å¤è®¾ç½®
    function restoreSettings() {
      // æ¢å¤ä¸»é¢˜
      const savedTheme = localStorage.getItem('epub_theme');
      if (savedTheme) {
        document.body.setAttribute('data-theme', savedTheme);
        const themeIcon = document.querySelector('#theme-toggle .btn-icon');
        if (themeIcon) {
          themeIcon.textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }
      }
      
      // æ¢å¤é˜…è¯»è®¾ç½®
      const savedSettings = localStorage.getItem('epub_settings');
      if (savedSettings) {
        try {
          const settings = JSON.parse(savedSettings);
          const fontSize = document.getElementById('fontsize');
          const lineHeight = document.getElementById('lineheight');
          const fontFamily = document.getElementById('fontfamily');
          
          if (fontSize) fontSize.value = settings.fontSize;
          if (lineHeight) lineHeight.value = settings.lineHeight;
          if (fontFamily) fontFamily.value = settings.fontFamily;
          
          applySettings();
        } catch (error) {
          console.log('æ¢å¤è®¾ç½®æ—¶å‡ºé”™:', error);
        }
      }
    }
  </script>
</body>
</html>